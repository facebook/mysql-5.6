--source include/have_debug.inc

create database db1;
use db1;

set @old_debug_val = @@global.debug;
set @@global.debug="+d,print_query_attr";

connect (con,localhost,root,,db1);
query_attrs_add a b;
select 1;

query_attrs_add b a;
select 1;

connection default;
select 1;

connection con;
query_attrs_delete a;
select 1;

query_attrs_reset;
select 1;

--perl
my $err_file = "$ENV{'MYSQLTEST_VARDIR'}/log/mysqld.1.err";
open LOG_FILE, $err_file or die "Failed to open $err_file for read";

my @lines = <LOG_FILE>;
my $total_lines = @lines;

# Scan the log from end
for (my $i = $total_lines - 1; $i >= 0; $i--) {

  # Exit the loop once the start of log of the current test case is seen
  if ($lines[$i] =~ m/CURRENT_TEST: main.query_attrs/) {
    print "Found the start of the test case in error log.\n";
    last;
  }

  # Looking for the debug log of query attributes
  if ($lines[$i] =~ m/\[query-attrs\]\[.*\](.*)/) {
    print $lines[$i]
  }
}
close LOG_FILE;
EOF

connection default;
set global debug = @old_debug_val;

drop database db1;
