--source include/have_rocksdb.inc

#
# This test checks some very basic capabilities
# for tables without primary keys. A hidden pk will be generated under the hood
# in myrocks.  Everything should work here as normal.
#

--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings

# test CREATE with SK
#CREATE TABLE t1 (a INT, b CHAR(8), c INT NOT NULL AUTO_INCREMENT, KEY(c)) ENGINE=rocksdb;
#CREATE TABLE t1 (a INT, b CHAR(8), KEY(a), pk INT AUTO_INCREMENT PRIMARY KEY) ENGINE=rocksdb;
CREATE TABLE t1 (a INT, b CHAR(8), KEY(a)) ENGINE=rocksdb;
SHOW CREATE TABLE t1;
SHOW COLUMNS IN t1;

## test INSERT on SK
INSERT INTO t1 (a,b) VALUES (35,'foo');
INSERT INTO t1 (a,b) VALUES (76,'bar');
INSERT INTO t1 (a,b) VALUES (77,'baz');

## test SELECT w/ index scans
--sorted_result
SELECT * FROM t1 WHERE a = 35;
--sorted_result
SELECT * FROM t1 WHERE a = 35 AND b = 'foo';
--sorted_result
SELECT * FROM t1 WHERE a = 77 OR b = 'bar';
--sorted_result
SELECT * FROM t1 WHERE a > 35;
--sorted_result
SELECT * FROM t1;

# test UPDATE
UPDATE t1 SET a=a+100;
--sorted_result
SELECT * FROM t1;

UPDATE t1 SET a=a-100, b='bbb' WHERE a>100;
UPDATE t1 SET a=300, b='ccc' WHERE a>70;
UPDATE t1 SET a=123 WHERE a=35;
UPDATE t1 SET a=321 WHERE b='ccc';
--sorted_result
SELECT * FROM t1;


# test RESTART/OPEN
--source include/restart_mysqld.inc
# test insert after restart
INSERT INTO t1 (a,b) VALUES (45,'bbb');
--sorted_result
SELECT * FROM t1;


# test DELETE
DELETE FROM t1 WHERE a=123;
--sorted_result
SELECT * FROM t1;

DELETE FROM t1 WHERE b > 'bbb' AND a > 100;
--sorted_result
SELECT * FROM t1;

#
# test DROP
DROP TABLE t1;

# test adding/dropping sk w/no pk
CREATE TABLE t1 (a INT, b CHAR(8)) ENGINE=rocksdb;
INSERT INTO t1 VALUES (1,'a'),(5,'z');

ALTER TABLE t1 ADD INDEX (b);
SHOW CREATE TABLE t1;

INSERT INTO t1 (a,b) VALUES (35,'c');
UPDATE t1 SET a=a-100, b='c' WHERE b>'b';
DELETE FROM t1 WHERE b= 'c';
--sorted_result
SELECT * FROM t1;

ALTER TABLE t1 DROP INDEX b;
INSERT INTO t1 (a,b) VALUES (35,'c');
UPDATE t1 SET a=a-100, b='c' WHERE b>'b';
DELETE FROM t1 WHERE b= 'c';
--sorted_result
SELECT * FROM t1;

DROP TABLE t1;


# test dropping pk w/ sk
CREATE TABLE t1 (a INT, b CHAR(8), pk INT AUTO_INCREMENT PRIMARY KEY) ENGINE=rocksdb;
INSERT INTO t1 (a, b) VALUES (1,'a'),(5,'z');

ALTER TABLE t1 DROP COLUMN pk;
SHOW CREATE TABLE t1;

INSERT INTO t1 (a,b) VALUES (35,'c');
UPDATE t1 SET a=a-100, b='c' WHERE b>'b';
DELETE FROM t1 WHERE b= 'c';
--sorted_result
SELECT * FROM t1;
DROP TABLE t1;

--echo #
--echo # MDEV-4313: RocksDB: Server crashes in LDBSE_KEYDEF::setup on dropping the primary key column
--echo #
CREATE TABLE t1 (pk INT PRIMARY KEY, i INT NOT NULL, KEY(i)) ENGINE=RocksDB;
ALTER TABLE t1 DROP COLUMN `pk`;
DROP TABLE t1;

# create table with multiple sk, make sure it still works
# test CREATE with SK
CREATE TABLE t1 (a INT, b CHAR(8), KEY(a), KEY(b)) ENGINE=rocksdb;
SHOW CREATE TABLE t1;
SHOW COLUMNS IN t1;

## test INSERT on SK
INSERT INTO t1 (a,b) VALUES (35,'foo');
INSERT INTO t1 (a,b) VALUES (76,'bar');
INSERT INTO t1 (a,b) VALUES (77,'baz');

## test SELECT w/ index scans
--sorted_result
SELECT * FROM t1 WHERE a = 35;
--sorted_result
SELECT * FROM t1 WHERE a = 35 AND b = 'foo';
--sorted_result
SELECT * FROM t1 WHERE a = 77 OR b = 'bar';
--sorted_result
SELECT * FROM t1 WHERE a > 35;
--sorted_result
SELECT * FROM t1;

# test UPDATE
UPDATE t1 SET a=a+100;
--sorted_result
SELECT * FROM t1;

UPDATE t1 SET a=a-100, b='bbb' WHERE a>100;
--sorted_result
SELECT * FROM t1;
UPDATE t1 SET a=300, b='ccc' WHERE a>70;
--sorted_result
SELECT * FROM t1;
UPDATE t1 SET a=123 WHERE a=35;
--sorted_result
SELECT * FROM t1;
UPDATE t1 SET a=321 WHERE b='ccc';
--sorted_result
SELECT * FROM t1;


# test RESTART/OPEN
--source include/restart_mysqld.inc
# test insert after restart
INSERT INTO t1 (a,b) VALUES (45,'bbb');
--sorted_result
SELECT * FROM t1;

# test DELETE
DELETE FROM t1 WHERE a=123;
--sorted_result
SELECT * FROM t1;

DELETE FROM t1 WHERE b > 'bbb' AND a > 100;
--sorted_result
SELECT * FROM t1;

#
# test DROP
DROP TABLE t1;

# test CREATE table with multi-part sk
CREATE TABLE t1 (a INT, b CHAR(8), KEY(a, b)) ENGINE=rocksdb;
SHOW CREATE TABLE t1;
SHOW COLUMNS IN t1;

## test INSERT on SK
INSERT INTO t1 (a,b) VALUES (35,'foo');
INSERT INTO t1 (a,b) VALUES (76,'bar');
INSERT INTO t1 (a,b) VALUES (77,'baz');

## test SELECT w/ index scans
--sorted_result
SELECT * FROM t1 WHERE a = 35;
--sorted_result
SELECT * FROM t1 WHERE a = 35 AND b = 'foo';
--sorted_result
SELECT * FROM t1 WHERE a = 77 OR b = 'bar';
--sorted_result
SELECT * FROM t1 WHERE a > 35;
--sorted_result
SELECT * FROM t1;

# test UPDATE
UPDATE t1 SET a=a+100;
--sorted_result
SELECT * FROM t1;

UPDATE t1 SET a=a-100, b='bbb' WHERE a>100;
--sorted_result
SELECT * FROM t1;
UPDATE t1 SET a=300, b='ccc' WHERE a>70;
--sorted_result
SELECT * FROM t1;
UPDATE t1 SET a=123 WHERE a=35;
--sorted_result
SELECT * FROM t1;
UPDATE t1 SET a=321 WHERE b='ccc';
--sorted_result
SELECT * FROM t1;


# test RESTART/OPEN
--source include/restart_mysqld.inc
# test insert after restart
INSERT INTO t1 (a,b) VALUES (45,'bbb');
--sorted_result
SELECT * FROM t1;

# test DELETE
DELETE FROM t1 WHERE a=123;
--sorted_result
SELECT * FROM t1;

DELETE FROM t1 WHERE b > 'bbb' AND a > 100;
--sorted_result
SELECT * FROM t1;

#
# test DROP
DROP TABLE t1;

# test CREATE table with more than one sk
CREATE TABLE t1 (a INT, b CHAR(8), KEY(a), KEY(b)) ENGINE=rocksdb;
SHOW CREATE TABLE t1;
SHOW COLUMNS IN t1;

## test INSERT on SK
INSERT INTO t1 (a,b) VALUES (35,'foo');
INSERT INTO t1 (a,b) VALUES (76,'bar');
INSERT INTO t1 (a,b) VALUES (77,'baz');

## test SELECT w/ index scans
--sorted_result
SELECT * FROM t1 WHERE a = 35;
--sorted_result
SELECT * FROM t1 WHERE a = 35 AND b = 'foo';
--sorted_result
SELECT * FROM t1 WHERE a = 77 OR b = 'bar';
--sorted_result
SELECT * FROM t1 WHERE a > 35;
--sorted_result
SELECT * FROM t1;

# test UPDATE
UPDATE t1 SET a=a+100;
--sorted_result
SELECT * FROM t1;

UPDATE t1 SET a=a-100, b='bbb' WHERE a>100;
--sorted_result
SELECT * FROM t1;
UPDATE t1 SET a=300, b='ccc' WHERE a>70;
--sorted_result
SELECT * FROM t1;
UPDATE t1 SET a=123 WHERE a=35;
--sorted_result
SELECT * FROM t1;
UPDATE t1 SET a=321 WHERE b='ccc';
--sorted_result
SELECT * FROM t1;


# test RESTART/OPEN
--source include/restart_mysqld.inc
# test insert after restart
INSERT INTO t1 (a,b) VALUES (45,'bbb');
--sorted_result
SELECT * FROM t1;

# test DELETE
DELETE FROM t1 WHERE a=123;
--sorted_result
SELECT * FROM t1;

DELETE FROM t1 WHERE b > 'bbb' AND a > 100;
--sorted_result
SELECT * FROM t1;

#
# test DROP
DROP TABLE t1;


# test check table with sk
CREATE TABLE t1 (a INT, b CHAR(8), KEY(a)) ENGINE=rocksdb;
INSERT INTO t1 (a) VALUES (1),(2),(5);
CHECK TABLE t1;
INSERT INTO t1 (a) VALUES (6),(8),(12);
CHECK TABLE t1 FOR UPGRADE;
INSERT INTO t1 (a) VALUES (13),(15),(16);
CHECK TABLE t1 QUICK;
INSERT INTO t1 (a) VALUES (17),(120),(132);
CHECK TABLE t1 FAST;
INSERT INTO t1 (a) VALUES (801),(900),(7714);
CHECK TABLE t1 MEDIUM;
INSERT INTO t1 (a) VALUES (8760),(10023),(12000);
CHECK TABLE t1 EXTENDED;
INSERT INTO t1 (a) VALUES (13345),(24456),(78302),(143028);
CHECK TABLE t1 CHANGED;
DROP TABLE t1;


