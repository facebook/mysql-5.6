--source include/have_rocksdb.inc

--disable_warnings
DROP TABLE IF EXISTS r1;
--enable_warnings

create table r1 (
 id1 int,
 id2 int,
 type int,
 value varchar(100),
 value2 int,
 value3 int,
 primary key (type, id1, id2),
 index id1_type (id1, type, value2, value, id2)
) engine=rocksdb collate latin1_bin;

select 'loading data';

--disable_query_log
let $i=0;
while ($i<1000)
{
  inc $i;
  eval insert r1(id1, id2, type, value, value2, value3) 
  values($i,$i,$i, 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',$i,$i);
}
--enable_query_log

set global rocksdb_force_flush_memtable_now=1;
optimize table r1;

--exec echo Test 1: Do a bunch of updates without setting the compaction sysvar
--exec echo Expect: no compaction
let $window = 0;
let $deletes = 0;
let $file_size = 0;
--source compact_deletes_test.inc

--exec echo Test 2: Do a bunch of updates and set the compaction sysvar
--exec echo Expect: compaction
let $window = 1000;
let $deletes = 990;
let $file_size = 0;
--source compact_deletes_test.inc

--exec echo Test 3: Do a bunch of updates and set the compaction sysvar and a file size to something large
--exec echo Expect: no compaction
let $window = 1000;
let $deletes = 1000;
let $file_size = 1000000;
--source compact_deletes_test.inc

drop table r1;