source include/have_rocksdb.inc;
# test that the query planner picks clustering keys for joins

# create table s
--disable_warnings
drop table if exists s;
--enable_warnings
create table s (a int, b int, c int) engine=rocksdb;

# populate table s
let $a = 10;
while ($a) {
    let $b = 10;
    while ($b) {
        let $c = 10;
        while ($c) {
            eval insert into s values ($a,$b,$c);
	    dec $c;
	}
	dec $b;
    }
    dec $a;
}
    
# create table t
--disable_warnings
drop table if exists t;
--enable_warnings
create table t like s;
insert into t select * from s;
set global rocksdb_force_flush_memtable_now=1;

# join with no keys
show create table s;
show create table t;
analyze table s;
analyze table t;
--replace_column 9 #
explain select straight_join s.a,t.a from s,t where s.b = t.b;

# join with uncovered keys
alter table s add key(b);
alter table t add key(b);
set global rocksdb_force_flush_memtable_now=1;
show create table s;
show create table t;
analyze table s;
analyze table t;
--replace_column 9 #
explain select straight_join s.a,t.a from s,t where s.b = t.b;

# join with uncovered keys and covering keys
# should pick the covering keys
alter table s add key(b,a);
alter table t add key(b,a);
set global rocksdb_force_flush_memtable_now=1;
show create table s;
show create table t;
analyze table s;
analyze table t;
--replace_column 9 #
explain select straight_join s.a,t.a from s,t where s.b = t.b;

# join with uncovered keys, covering keys and clustering keys
# should pick the covering keys
alter table s add clustering key(b);
alter table t add clustering key(b);
set global rocksdb_force_flush_memtable_now=1;
show create table s;
show create table t;
analyze table s;
analyze table t;
--replace_column 9 #
explain select straight_join s.a,t.a from s,t where s.b = t.b;

# join with uncovered keys and clustering keys
# should pick the clustering keys
alter table s drop key b_2;
alter table t drop key b_2;
set global rocksdb_force_flush_memtable_now=1;
show create table s;
show create table t;
analyze table s;
analyze table t;
--replace_column 9 #
explain select straight_join s.a,t.a from s,t where s.b = t.b;

# cleanup
drop table s,t;

