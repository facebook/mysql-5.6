--source include/have_rocksdb.inc

#
#  Tests for row checksums feature
#
--source include/have_debug.inc

--disable_warnings
drop table if exists t1,t2,t3;
--enable_warnings

show variables like 'rocksdb_%checksum%';

create table t1 (pk int primary key, a int, b int, key(a), key(b)) engine=rocksdb;
insert into t1 values (1,1,1),(2,2,2),(3,3,3);
check table t1;
--exec grep -A6 "Checking table t1" $MYSQLTEST_VARDIR/log/mysqld.1.err | cut -d] -f2 
drop table t1;

set session rocksdb_store_checksums=on;
create table t2 (pk int primary key, a int, b int, key(a), key(b)) engine=rocksdb;
insert into t2 values (1,1,1),(2,2,2),(3,3,3);
check table t2;
--exec grep -A6 "Checking table t2" $MYSQLTEST_VARDIR/log/mysqld.1.err | cut -d] -f2 


--echo # Now, make a table that has both rows with checksums and without
create table t3 (pk int primary key, a int, b int, key(a), key(b)) engine=rocksdb;
insert into t3 values (1,1,1),(2,2,2),(3,3,3);
set session rocksdb_store_checksums=off;
update t3 set b=3 where a=2;
set session rocksdb_store_checksums=on;
check table t3;
--exec grep -A6 "Checking table t3" $MYSQLTEST_VARDIR/log/mysqld.1.err | cut -d] -f2 


--echo #
--echo # Ok, table t2 has all rows with checksums. Simulate a few checksum mismatches.
--echo #
insert into mtr.test_suppressions values 
 ('Checksum mismatch in key of key-value pair for index'),
 ('Checksum mismatch in value of key-value pair for index'),
 ('Data with incorrect checksum');

--echo # 1. Start with mismatch in key checksum of the PK.
set session debug= "+d,myrocks_simulate_bad_pk_checksum1";
set session rocksdb_verify_checksums=off;
select * from t3;
set session rocksdb_verify_checksums=on;
--error ER_INTERNAL_ERROR
select * from t3;
set session debug= "-d,myrocks_simulate_bad_pk_checksum1";

--echo # 2. Continue with mismatch in pk value checksum.
set session debug= "+d,myrocks_simulate_bad_pk_checksum2";
set session rocksdb_verify_checksums=off;
select * from t3;
set session rocksdb_verify_checksums=on;
--error ER_INTERNAL_ERROR
select * from t3;
set session debug= "-d,myrocks_simulate_bad_pk_checksum2";

--echo # 3. Check if we catch checksum mismatches for secondary indexes
explain
select * from t3 force index(a) where a<4;
select * from t3 force index(a) where a<4;

set session debug= "+d,myrocks_simulate_bad_key_checksum1";
--error ER_INTERNAL_ERROR
select * from t3 force index(a) where a<4;
set session debug= "-d,myrocks_simulate_bad_key_checksum1";

--echo # 4. The same for index-only reads?
explain 
select a from t3 force index(a) where a<4;
select a from t3 force index(a) where a<4;

set session debug= "+d,myrocks_simulate_bad_key_checksum1";
--error ER_INTERNAL_ERROR
select a from t3 force index(a) where a<4;
set session debug= "-d,myrocks_simulate_bad_key_checksum1";

drop table t2,t3;
