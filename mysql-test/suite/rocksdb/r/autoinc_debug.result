#
# Testing upgrading from server without merges for auto_increment
# to new server with such support.
#
set debug='+d,myrocks_autoinc_upgrade';
create table t (i int primary key auto_increment);
insert into t values ();
insert into t values ();
insert into t values ();
select * from t;
i
1
2
3
delete from t where i > 1;
select * from t;
i
1
select table_name, index_name, auto_increment
from information_schema.rocksdb_ddl where table_name = 't';
table_name	index_name	auto_increment
t	PRIMARY	NULL
set debug='-d,myrocks_autoinc_upgrade';
insert into t values ();
insert into t values ();
insert into t values ();
select * from t;
i
1
2
3
4
select table_name, index_name, auto_increment
from information_schema.rocksdb_ddl where table_name = 't';
table_name	index_name	auto_increment
t	PRIMARY	5
delete from t where i > 1;
insert into t values ();
insert into t values ();
insert into t values ();
select * from t;
i
1
5
6
7
drop table t;
#
# Testing crash safety of transactions.
#
create table t (i int primary key auto_increment);
insert into t values ();
insert into t values ();
insert into t values ();
# Before anything
set debug="+d,crash_commit_before";
insert into t values ();
ERROR HY000: Lost connection to MySQL server during query
select table_schema, table_name, auto_increment from information_schema.tables where table_name = 't';
table_schema	table_name	auto_increment
test	t	4
select max(i) from t;
max(i)
3
set debug="-d,crash_commit_before";
# After engine prepare
set debug="+d,crash_commit_after_prepare";
insert into t values ();
ERROR HY000: Lost connection to MySQL server during query
select table_schema, table_name, auto_increment from information_schema.tables where table_name = 't';
table_schema	table_name	auto_increment
test	t	4
select max(i) from t;
max(i)
3
set debug="-d,crash_commit_after_prepare";
# After binlog
set debug="+d,crash_commit_after_log";
insert into t values ();
ERROR HY000: Lost connection to MySQL server during query
select table_schema, table_name, auto_increment from information_schema.tables where table_name = 't';
table_schema	table_name	auto_increment
test	t	5
select max(i) from t;
max(i)
4
set debug="-d,crash_commit_after_log";
# After everything
set debug="+d,crash_commit_after";
insert into t values ();
ERROR HY000: Lost connection to MySQL server during query
select table_schema, table_name, auto_increment from information_schema.tables where table_name = 't';
table_schema	table_name	auto_increment
test	t	6
select max(i) from t;
max(i)
5
set debug="-d,crash_commit_after";
drop table t;
