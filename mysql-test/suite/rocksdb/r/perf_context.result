DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t2;
SET @prior_rocksdb_perf_context_level = @@rocksdb_perf_context_level;
SET GLOBAL rocksdb_perf_context_level=2;
CREATE TABLE t1 (i INT, j INT, PRIMARY KEY (i)) ENGINE = ROCKSDB;
CREATE TABLE t2 (k INT, PRIMARY KEY (k)) ENGINE = ROCKSDB;
INSERT INTO t1 VALUES (1,1), (2,2), (3,3), (4,4), (5,5);
SELECT * FROM INFORMATION_SCHEMA.ROCKSDB_PERF_CONTEXT WHERE TABLE_NAME = 't1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	STAT_TYPE	VALUE
test	t1	NULL	INTERNAL_KEY_SKIPPED_COUNT	#
test	t1	NULL	INTERNAL_DELETE_SKIPPED_COUNT	#
test	t1	NULL	DB_MUTEX_LOCK_NANOS	#
test	t1	NULL	DB_CONDITION_WAIT_NANOS	#
test	t1	NULL	IO_OPEN_NANOS	#
test	t1	NULL	IO_ALLOCATE_NANOS	#
test	t1	NULL	IO_WRITE_NANOS	#
test	t1	NULL	IO_READ_NANOS	#
test	t1	NULL	IO_RANGE_SYNC_NANOS	#
test	t1	NULL	IO_LOGGER_NANOS	#
SELECT * FROM INFORMATION_SCHEMA.ROCKSDB_PERF_CONTEXT_GLOBAL;
STAT_TYPE	VALUE
INTERNAL_KEY_SKIPPED_COUNT	#
INTERNAL_DELETE_SKIPPED_COUNT	#
DB_MUTEX_LOCK_NANOS	#
DB_CONDITION_WAIT_NANOS	#
IO_OPEN_NANOS	#
IO_ALLOCATE_NANOS	#
IO_WRITE_NANOS	#
IO_READ_NANOS	#
IO_RANGE_SYNC_NANOS	#
IO_LOGGER_NANOS	#
SELECT * FROM INFORMATION_SCHEMA.ROCKSDB_PERF_CONTEXT
WHERE TABLE_NAME = 't1'
AND STAT_TYPE in ('INTERNAL_KEY_SKIPPED_COUNT', 'INTERNAL_DELETE_SKIPPED_COUNT');
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	STAT_TYPE	VALUE
test	t1	NULL	INTERNAL_KEY_SKIPPED_COUNT	0
test	t1	NULL	INTERNAL_DELETE_SKIPPED_COUNT	0
SELECT * FROM t1;
i	j
1	1
2	2
3	3
4	4
5	5
SELECT * FROM INFORMATION_SCHEMA.ROCKSDB_PERF_CONTEXT
WHERE TABLE_NAME = 't1'
AND STAT_TYPE in ('INTERNAL_KEY_SKIPPED_COUNT', 'INTERNAL_DELETE_SKIPPED_COUNT');
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	STAT_TYPE	VALUE
test	t1	NULL	INTERNAL_KEY_SKIPPED_COUNT	5
test	t1	NULL	INTERNAL_DELETE_SKIPPED_COUNT	0
SELECT * FROM t1 WHERE j BETWEEN 1 AND 5;
i	j
1	1
2	2
3	3
4	4
5	5
SELECT * FROM INFORMATION_SCHEMA.ROCKSDB_PERF_CONTEXT
WHERE TABLE_NAME = 't1'
AND STAT_TYPE in ('INTERNAL_KEY_SKIPPED_COUNT', 'INTERNAL_DELETE_SKIPPED_COUNT');
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	STAT_TYPE	VALUE
test	t1	NULL	INTERNAL_KEY_SKIPPED_COUNT	10
test	t1	NULL	INTERNAL_DELETE_SKIPPED_COUNT	0
BEGIN;
INSERT INTO t2 VALUES (1), (2);
INSERT INTO t2 VALUES (3), (4);
COMMIT;
SELECT COUNT(*) from INFORMATION_SCHEMA.ROCKSDB_PERF_CONTEXT
WHERE TABLE_NAME = 't2'
AND STAT_TYPE = 'IO_WRITE_NANOS'
AND VALUE > 0;
COUNT(*)
0
SELECT COUNT(*) from INFORMATION_SCHEMA.ROCKSDB_PERF_CONTEXT_GLOBAL
WHERE STAT_TYPE = 'IO_WRITE_NANOS' AND VALUE > 0;
COUNT(*)
1
INSERT INTO t2 VALUES (5), (6), (7), (8);
SELECT COUNT(*) from INFORMATION_SCHEMA.ROCKSDB_PERF_CONTEXT
WHERE TABLE_NAME = 't2'
AND STAT_TYPE = 'IO_WRITE_NANOS'
AND VALUE > 0;
COUNT(*)
1
DROP TABLE t1;
DROP TABLE t2;
SET GLOBAL rocksdb_perf_context_level = @prior_rocksdb_perf_context_level;
