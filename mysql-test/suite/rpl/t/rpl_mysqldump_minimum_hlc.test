# The tests in this file is intended to test the following:
# 1. mysqldump generates a sql to set minimum_hlc
# 2. When the sql generated by #1 is replayed on the destination instance, minimum_hlc is updated correctly
# 3. All subsequent trx in destination instance will get monotonically increasing HLC

--source include/have_gtid.inc
--source include/have_debug.inc
--source include/master-slave.inc
--source include/have_innodb.inc
--source include/have_binlog_format_row.inc
--source include/not_parallel.inc

# Cleanup old binlog
connection master;
--source include/sync_slave_sql_with_master.inc
connection master;
flush logs;
let $binlog= query_get_value(SHOW MASTER STATUS, File, 1);
replace_result $binlog binlog;
eval purge binary logs to '$binlog';

connection slave;
flush logs;
let $binlog= query_get_value(SHOW MASTER STATUS, File, 1);
replace_result $binlog binlog;
eval purge binary logs to '$binlog';

# Setup
# Set minimum_hlc_ns to a high value. Subsequent txn's should see monotonically
# increasing timestamp from this point
connection master;
SET SESSION DEBUG="+d,allow_long_hlc_drift_for_tests";
SET @@global.minimum_hlc_ns = 2538630000000000000; # ~2050 AD

# Enable binlog_hlc in both master and slave
connection master;
SET @@global.enable_binlog_hlc = true;
connection slave;
SET @@global.enable_binlog_hlc = true;
SET @@global.maximum_hlc_drift_ns = 2538630000000000000; # ~2050 AD

# Stop the slave
--connection slave
--source include/stop_slave.inc

# Generate some trx in master
--echo Generate some txns in master instance
--connection master
create table t1 (a int primary key, b char(8)) engine=Innodb;
create table t2 (a int primary key, b char(8)) engine=Innodb;

# Single-statement transaction
set @@session.autocommit= on;
insert into t1 values (1, 'a');
insert into t2 values (1, 'a');

# Multi-statement transaction
set @@session.autocommit= off;
begin;
  insert into t1 values (2, 'b');
  insert into t1 values (3, 'c');
  insert into t2 values (2, 'b');
  insert into t2 values (3, 'c');
commit;

select * from t1;
select * from t2;

--let $binlog_file= LAST
--source include/show_binlog_events.inc

# Try to restore t1 on slave instance by getting a dump in master
--echo Restoring t1 on slave through mysqlbinlog should carry HLC from the master instance
--exec $MYSQL_DUMP --user=root --host=127.0.0.1  --single-transaction --set-minimum-hlc --port=$MASTER_MYPORT test > $MYSQLTEST_VARDIR/tmp/mysqldump1.sql

--echo Now replay the dump on slave instance
--exec $MYSQL --user=root --host=127.0.0.1 --port=$SLAVE_MYPORT test < $MYSQLTEST_VARDIR/tmp/mysqldump1.sql

--let $diff_tables= master:t1, slave:t1
--source include/diff_tables.inc

--let $diff_tables= master:t2, slave:t2
--source include/diff_tables.inc

--connection slave
select * from t1;
select * from t2;

# Generate some txns explicitly on slave instance. HLC should increase
# monotonically
--echo HLC increases monotonically for txns generated on slave instance
create table t3 (a int primary key, b char(8)) engine=Innodb;
insert into t3 values (1, 'a');
insert into t3 values (2, 'b');

--let $binlog_file= LAST
--source include/show_binlog_events.inc

drop table t3;
--source include/start_slave.inc

# Cleanup
connection master;
drop table t1;
drop table t2;
flush logs;
SET @@global.minimum_hlc_ns = default;
SET @@global.enable_binlog_hlc = default;

--source include/sync_slave_sql_with_master.inc
connection slave;
SET SESSION DEBUG = "+d,reset_hlc_for_tests";
SET @@global.minimum_hlc_ns = default;
SET SESSION DEBUG = "-d,reset_hlc_for_tests";
SET @@global.enable_binlog_hlc = default;
SET @@global.maximum_hlc_drift_ns = default;

--source include/rpl_end.inc
