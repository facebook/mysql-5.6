# This test verifies slave_type_conversions when
# rbr_column_names is enabled for a table.
source include/have_binlog_format_row.inc;
source include/master-slave.inc;

connection slave;
set @saved_slave_type_conversions = @@global.slave_type_conversions;
set @@global.slave_type_conversions = 'ALL_LOSSY,ALL_NON_LOSSY';

connection master;
create table t1(a int, b tinyblob, c int) rbr_column_names=1;
sync_slave_with_master;

--echo Check slave can deal with reordering of columns
drop table t1;
create table t1(a int, c tinyint, b mediumblob) rbr_column_names=1;
connection master;
insert into t1 values(1, "tiny blob", 100);
sync_slave_with_master;
select * from t1;

--echo Check slave can deal with deleted columns
drop table t1;
create table t1(c tinyint, b mediumblob) rbr_column_names=1;
connection master;
insert into t1 values(1, "tiny blob", 100);
sync_slave_with_master;
select * from t1;

--echo Check slave can deal with added columns
drop table t1;
create table t1(a int, d int, c tinyint, b mediumblob) rbr_column_names=1;
connection master;
insert into t1 values(1, "tiny blob", 100);
sync_slave_with_master;
select * from t1;

connection master;
--echo Check slave can deal with deleted columns in the middle
create table t2 (a int, b varchar(1000), c enum('1','2','3'), d int) engine=innodb rbr_column_names=1;sync_slave_with_master;
connection slave;
drop table t2;
create table t2(a int, b text, d int) engine=innodb rbr_column_names=1;
connection master;
insert into t2 values(1, "column2", 1, 1);
sync_slave_with_master;
select * from t2;

--echo Check slave can deal with added columns in the middle
connection slave;
drop table t2;
create table t2(a int, e enum('1','2','3'), b text, d int) engine=innodb rbr_column_names=1;
connection master;
insert into t2 values(1, "column2", 1, 1);
sync_slave_with_master;
select * from t2;

set @@global.slave_type_conversions = @saved_slave_type_conversions;
connection master;
drop table t1;
drop table t2;
source include/rpl_end.inc;

