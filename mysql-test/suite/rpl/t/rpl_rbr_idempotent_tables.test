source include/master-slave.inc;
source include/have_binlog_format_row.inc;

connection master;
create table test_table1 (a int primary key);
insert into test_table1 values(1);

sync_slave_with_master;
set @old_var = @@global.rbr_idempotent_tables;
source include/stop_slave_sql.inc;
set @@global.rbr_idempotent_tables='test_table1';
source include/start_slave_sql.inc;

connection slave;
insert into test_table1 values(2);
error ER_SLAVE_MUST_STOP;
set @@global.rbr_idempotent_tables='';

connection master;
# Slave SQL thread doesn't hit duplicate key error.
insert into test_table1 values(2);

sync_slave_with_master;
source include/stop_slave_sql.inc;
set @@global.rbr_idempotent_tables = @old_var;
source include/start_slave_sql.inc;

connection master;
drop table test_table1;
source include/rpl_end.inc;
