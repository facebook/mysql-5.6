include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information.
[connection master]
SET @@GLOBAL.WRITE_STATS_FREQUENCY=3;
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=3;
SET @@GLOBAL.WRITE_STATS_FREQUENCY=3;
SET @@GLOBAL.WRITE_THROTTLE_LAG_PCT_MIN_SECONDARIES=10;
SET @@GLOBAL.WRITE_START_THROTTLE_LAG_MILLISECONDS=3000;
SET @@GLOBAL.WRITE_STOP_THROTTLE_LAG_MILLISECONDS=1000;
SET @@GLOBAL.WRITE_THROTTLE_MIN_RATIO=1.5;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=WARN;
create table t(a int) engine=innodb;
select @@GLOBAL.WRITE_STATS_FREQUENCY into @ws_freq;
select @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY into @wat_freq;
### We use the following sleep statement throughout this test to deterministically enforce the auto_throttling system to check for 
### lag for the next write statement and enforce a new time bucket for write statistics collection
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
####################################################
### Test 1: Auto throttle start & stop based on sql_id
####################################################
insert into t values(1);
insert into t values(2);
delete from t where a = 2;
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	108
SHARD	test	108
SQL_ID	1df4de2a8dd27d161264765258e6603b64e3c91210f21de1c8dfea72966479b3	72
SQL_ID	c83a90a83d28399b1960356de86ac91583d8173e49826fdf93cf04bfb7db7ea4	36
USER	root	108
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
####### Next Cycle #######
### Expectation - There is replication lag. The system should identity insert query sql_id as the culprit and start monitoring it ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into t values(2);
insert into t values(2);
delete from t where a = 2;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	0
####### Next Cycle #######
### Expectation - Replication lag still persists, Insert query sql_id should be throttled. Expect warnings. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into t values(2);
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	1df4de2a8dd27d161264765258e6603b64e3c91210f21de1c8dfea72966479b3
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	1
select count from performance_schema.write_throttling_log where type = 'SQL_ID' and mode = 'AUTO';
count
1
####### Next Cycle #######
### Expectation - Replication lag between start and end threshold, Expect warning for every insert query. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_between_start_end_throttle_threshold';
insert into t values(2);
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	2
select count from performance_schema.write_throttling_log where type = 'SQL_ID' and mode = 'AUTO';
count
2
####### Next Cycle #######
### Expectation - Replication lag goes away, Insert query should not be throttled anymore. Expect warnings count to not increase anymore. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_between_start_end_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_below_end_throttle_threshold';
insert into t values(2);
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	2
select count from performance_schema.write_throttling_log where type = 'SQL_ID' and mode = 'AUTO';
count
2
####### Reset #######
TRUNCATE t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
truncate table performance_schema.events_errors_summary_global_by_error;
set @@global.debug= '-d,dbug.simulate_lag_below_end_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
####################################################
### Test 2: Auto throttle start & stop based on shard
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
create database test1;
create table test1.t(a int) engine=innodb;
insert into test.t values(2);
delete from test.t where a = 2;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	144
SHARD	test	144
SQL_ID	24ddf49d0393e337d0a5c6ca90895af2dda310c1b3fc036e89b9c7bd744dc2c1	36
SQL_ID	3fd767db8963952ac673e8abdedabb4f4e05d48a73f1d9662a53746d78acc75a	36
SQL_ID	5a689cb01803d4479e00d7ceb18fce27ec68127eef6a535abb4018db5b629cf3	36
SQL_ID	fd3a52d9aac1d879830582a3123bd6d77f48f60d4327523ed10462d084da584d	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. The system should identity shard 'test' as the culprit since there is no conclusive sql_id culprit. Should start monitoring 'test' shard ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into test1.t values(2);
delete from test1.t where a = 2;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	0
####### Next Cycle #######
### Expectation - Replication lag still persists, Shard 'test' should be throttled. Expect warnings. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into test1.t values(2);
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
SHARD	test
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	1
select count from performance_schema.write_throttling_log where type = 'SHARD' and mode = 'AUTO';
count
1
####### Next Cycle #######
### Expectation - Replication lag goes away, Shard 'test' should not be throttled anymore. Expect warnings count to not increase anymore. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_below_end_throttle_threshold';
insert into test1.t values(2);
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	1
select count from performance_schema.write_throttling_log where type = 'SHARD' and mode = 'AUTO';
count
1
####### Reset #######
TRUNCATE test.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
drop database test1;
truncate table performance_schema.events_errors_summary_global_by_error;
set @@global.debug= '-d,dbug.simulate_lag_below_end_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
####################################################
### Test 3: Auto throttle fallback sql id in case of no 
### conclusive culprit
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MIN_RATIO=3;
create database test1;
create table test1.t(a int) engine=innodb;
insert into test.t values(2);
insert into test.t values(2);
delete from test.t where a = 2;
insert into test1.t values(2);
delete from test1.t where a = 2;
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	185
SHARD	test	185
SQL_ID	24ddf49d0393e337d0a5c6ca90895af2dda310c1b3fc036e89b9c7bd744dc2c1	41
SQL_ID	3fd767db8963952ac673e8abdedabb4f4e05d48a73f1d9662a53746d78acc75a	36
SQL_ID	5a689cb01803d4479e00d7ceb18fce27ec68127eef6a535abb4018db5b629cf3	72
SQL_ID	fd3a52d9aac1d879830582a3123bd6d77f48f60d4327523ed10462d084da584d	36
USER	root	185
set @@global.debug= '+d,dbug.simulate_fallback_sql_throttling';
####### Next Cycle #######
### Expectation - There is replication lag. As per the setup, the system should fallback to monitoring the top sql_id(insert query) with most bytes written. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into test.t values(2);
insert into test.t values(2);
delete from test.t where a = 2;
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	113
SHARD	test	113
SQL_ID	24ddf49d0393e337d0a5c6ca90895af2dda310c1b3fc036e89b9c7bd744dc2c1	41
SQL_ID	5a689cb01803d4479e00d7ceb18fce27ec68127eef6a535abb4018db5b629cf3	72
USER	root	113
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	0
####### Next Cycle #######
### Expectation - Replication lag still persists, Insert query sql_id should be throttled. Expect warnings. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into test.t values(2);
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	5a689cb01803d4479e00d7ceb18fce27ec68127eef6a535abb4018db5b629cf3
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	1
####### Next Cycle #######
### Expectation - Replication lag goes away, Insert query sql_id should not be throttled anymore. Expect warnings count to not increase anymore. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_below_end_throttle_threshold';
insert into test.t values(2);
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	1
####### Reset #######
TRUNCATE test.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MIN_RATIO=1.5;
drop database test1;
truncate table performance_schema.events_errors_summary_global_by_error;
set @@global.debug= '-d,dbug.simulate_lag_below_end_throttle_threshold';
set @@global.debug= '-d,dbug.simulate_fallback_sql_throttling';
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
####################################################
### Test 4: Auto throttle multiple sql_ids and releasing
### them in order one by one after replication lag goes away
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
insert into t values(1);
insert into t values(2);
insert into t values(3);
insert into t values(4);
delete from t where a = 1;
delete from t where a = 2;
update t set a = 1 where a = 3;
update t set a = 2 where a = 4;
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	300
SHARD	test	300
SQL_ID	1df4de2a8dd27d161264765258e6603b64e3c91210f21de1c8dfea72966479b3	144
SQL_ID	964a3aed67b79c1fd0187e3d6606282308d01d46f6f0f699bdfe848369f85757	84
SQL_ID	c83a90a83d28399b1960356de86ac91583d8173e49826fdf93cf04bfb7db7ea4	72
USER	root	300
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
####### Next Cycle #######
### Expectation - There is replication lag. The system should identify insert query sql_id as the culprit and start throttling it. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into t values(3);
update t set a = 4 where a = 3;
delete from t where a = 1;
delete from t where a = 2;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	1df4de2a8dd27d161264765258e6603b64e3c91210f21de1c8dfea72966479b3
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	1
####### Next Cycle #######
### Expectation - Replication lag still persists. The system should identify delete query sql_id as the culprit and start throttling it as well. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into t values(3);
delete from t where a = 4;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	c83a90a83d28399b1960356de86ac91583d8173e49826fdf93cf04bfb7db7ea4
SQL_ID	1df4de2a8dd27d161264765258e6603b64e3c91210f21de1c8dfea72966479b3
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	3
####### Next Cycle #######
### Expectation - Replication lag goes away. The system should stop throttling insert query but still throttle delete query. Expect warnings from delete queries ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
set @@global.debug= '+d,dbug.simulate_lag_below_end_throttle_threshold';
insert into t values(4);
delete from t where a = 3;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	c83a90a83d28399b1960356de86ac91583d8173e49826fdf93cf04bfb7db7ea4
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	4
####### Next Cycle #######
### Expectation - Replication lag goes away. The system should release the delete query now and stop throttling it. Expect warnings count to not increase ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into t values(5);
delete from t where a = 4;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	4
####### Reset #######
TRUNCATE t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
truncate table performance_schema.events_errors_summary_global_by_error;
set @@global.debug= '-d,dbug.simulate_lag_below_end_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
####################################################
### Test 5: Monitored entities are dynamically updated if 
### a new potential culprit is found
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
insert into t values(1);
insert into t values(2);
insert into t values(3);
insert into t values(4);
insert into t values(5);
insert into t values(6);
insert into t values(7);
delete from t where a = 6;
delete from t where a = 7;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	324
SHARD	test	324
SQL_ID	1df4de2a8dd27d161264765258e6603b64e3c91210f21de1c8dfea72966479b3	252
SQL_ID	c83a90a83d28399b1960356de86ac91583d8173e49826fdf93cf04bfb7db7ea4	72
USER	root	324
####### Next Cycle #######
### Expectation - There is replication lag. The system should identify insert query sql_id as the culprit and start monitoring it. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into t values(6);
delete from t where a = 1;
delete from t where a = 2;
delete from t where a = 3;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	144
SHARD	test	144
SQL_ID	1df4de2a8dd27d161264765258e6603b64e3c91210f21de1c8dfea72966479b3	36
SQL_ID	c83a90a83d28399b1960356de86ac91583d8173e49826fdf93cf04bfb7db7ea4	108
USER	root	144
####### Next Cycle #######
### Expectation - Replication lag still persists but in the last cycle the system should identify delete query as the culprit and update the sql_id to be monitored. Should not throttle it yet. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into t values(6);
delete from t where a = 4;
delete from t where a = 5;
delete from t where a = 6;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	149
SHARD	test	149
SQL_ID	1df4de2a8dd27d161264765258e6603b64e3c91210f21de1c8dfea72966479b3	36
SQL_ID	c83a90a83d28399b1960356de86ac91583d8173e49826fdf93cf04bfb7db7ea4	113
USER	root	149
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	0
####### Next Cycle #######
### Expectation - Replication lag still persists. The system should identify delete query as the culprit and throttle it. Expect warnings. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
insert into t values(1);
delete from t where a = 1;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
SQL_ID	c83a90a83d28399b1960356de86ac91583d8173e49826fdf93cf04bfb7db7ea4
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	72
SHARD	test	72
SQL_ID	1df4de2a8dd27d161264765258e6603b64e3c91210f21de1c8dfea72966479b3	36
SQL_ID	c83a90a83d28399b1960356de86ac91583d8173e49826fdf93cf04bfb7db7ea4	36
USER	root	72
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	1
####### Reset #######
TRUNCATE t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
truncate table performance_schema.events_errors_summary_global_by_error;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
####################################################
### Test 6: Auto throttle start & stop based on client
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
create database test1;
create table test1.t(a int) engine=innodb;
insert into test.t values(2);
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	144
SHARD	test	72
SHARD	test1	72
SQL_ID	24ddf49d0393e337d0a5c6ca90895af2dda310c1b3fc036e89b9c7bd744dc2c1	36
SQL_ID	3fd767db8963952ac673e8abdedabb4f4e05d48a73f1d9662a53746d78acc75a	36
SQL_ID	5a689cb01803d4479e00d7ceb18fce27ec68127eef6a535abb4018db5b629cf3	36
SQL_ID	fd3a52d9aac1d879830582a3123bd6d77f48f60d4327523ed10462d084da584d	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. Based on the write stats, there is no clear sql_id or shard as the culprit. Should identify client_id as the culprit and throttle it. ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
delete from test1.t where a = 2;
insert into test.t values(2);
delete from test1.t where a = 2;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
CLIENT	HARDCODED_CLIENT_ID
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	4
####### Reset #######
use test;
TRUNCATE test.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
drop database test1;
truncate table performance_schema.events_errors_summary_global_by_error;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
####################################################
### Test 7: No throttling if WRITE_AUTO_THROTTLE_FREQUENCY = 0
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=0;
create database test1;
create table test1.t(a int) engine=innodb;
insert into test.t values(2);
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	144
SHARD	test	72
SHARD	test1	72
SQL_ID	24ddf49d0393e337d0a5c6ca90895af2dda310c1b3fc036e89b9c7bd744dc2c1	36
SQL_ID	3fd767db8963952ac673e8abdedabb4f4e05d48a73f1d9662a53746d78acc75a	36
SQL_ID	5a689cb01803d4479e00d7ceb18fce27ec68127eef6a535abb4018db5b629cf3	36
SQL_ID	fd3a52d9aac1d879830582a3123bd6d77f48f60d4327523ed10462d084da584d	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag but WRITE_AUTO_THROTTLE_FREQUENCY is set to 0. The system should not throttle any entity. No warnings ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
delete from test1.t where a = 2;
insert into test.t values(2);
delete from test1.t where a = 2;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	0
####### Reset #######
use test;
TRUNCATE test.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=3;
drop database test1;
truncate table performance_schema.events_errors_summary_global_by_error;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
####################################################
### Test 8: Auto throttle throws error if write_control_level=ERROR
####################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=ERROR;
create database test1;
create table test1.t(a int) engine=innodb;
insert into test.t values(2);
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	144
SHARD	test	72
SHARD	test1	72
SQL_ID	24ddf49d0393e337d0a5c6ca90895af2dda310c1b3fc036e89b9c7bd744dc2c1	36
SQL_ID	3fd767db8963952ac673e8abdedabb4f4e05d48a73f1d9662a53746d78acc75a	36
SQL_ID	5a689cb01803d4479e00d7ceb18fce27ec68127eef6a535abb4018db5b629cf3	36
SQL_ID	fd3a52d9aac1d879830582a3123bd6d77f48f60d4327523ed10462d084da584d	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. The client should be identified as the entity to be throttled ###
### Should throw erros when WRITE_CONTROL_LEVEL is set to ERROR but should only throw warnings when it is set to WARN ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
insert into test1.t values(2);
ERROR HY000: Exceeded write workload limit. Try again later
delete from test1.t where a = 2;
ERROR HY000: Exceeded write workload limit. Try again later
SET @@GLOBAL.WRITE_CONTROL_LEVEL=WARN;
insert into test.t values(2);
delete from test1.t where a = 2;
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
CLIENT	HARDCODED_CLIENT_ID
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	4
####### Reset #######
use test;
TRUNCATE test.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
drop database test1;
truncate table performance_schema.events_errors_summary_global_by_error;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
################################################################################
### Test 9: Auto throttle throws error if client attribute mt_throttle_okay is set.
################################################################################
SET @@GLOBAL.WRITE_STATS_COUNT=10;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=0;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=WARN;
SET @@SESSION.WRITE_THROTTLE_TAG_ONLY=TRUE;
create database test1;
create table test1.t(a int) engine=innodb;
insert into test.t values(2);
delete from test.t where a = 2;
use test1;
insert into test1.t values(2);
delete from test1.t where a = 2;
select type, value, write_data_bytes from performance_schema.write_statistics where timestamp = (select max(timestamp) from performance_schema.write_statistics) order by type, value;
type	value	write_data_bytes
CLIENT	HARDCODED_CLIENT_ID	144
SHARD	test	72
SHARD	test1	72
SQL_ID	24ddf49d0393e337d0a5c6ca90895af2dda310c1b3fc036e89b9c7bd744dc2c1	36
SQL_ID	3fd767db8963952ac673e8abdedabb4f4e05d48a73f1d9662a53746d78acc75a	36
SQL_ID	5a689cb01803d4479e00d7ceb18fce27ec68127eef6a535abb4018db5b629cf3	36
SQL_ID	fd3a52d9aac1d879830582a3123bd6d77f48f60d4327523ed10462d084da584d	36
USER	root	144
####### Next Cycle #######
### Expectation - There is replication lag. The client should be identified as the entity to be throttled ###
### Should throw errors when client attribute mt_throttle_okay is set to ERROR but should only throw warnings when it is set to WARN ###
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
set @@global.debug= '+d,dbug.simulate_lag_above_start_throttle_threshold';
### should quarantine the client, next query should not be throttled as the query tag is not present
insert into test1.t values(2);
### next query should be throttled(warning) as the query tag is present
insert into test1.t values(2);
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	1
### next query should be throttled(error) as the query tag is present
insert into test1.t values(2);
ERROR HY000: Exceeded write workload limit. Try again later
### next query should not be throttled as tag is not set correctly
insert into test1.t values(2);
### multi-query should also be throttled based on tag present at the beginning. 
select 1; 
insert into test1.t values(2);
||||
1
1
ERROR HY000: Exceeded write workload limit. Try again later
SET @@SESSION.WRITE_THROTTLE_TAG_ONLY=FALSE;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=ERROR;
### next query should be throttled as tag based throttling is turned off but client is still the culprit
insert into test1.t values(2);
ERROR HY000: Exceeded write workload limit. Try again later
select type, value from performance_schema.write_throttling_rules where mode = 'AUTO';
type	value
CLIENT	HARDCODED_CLIENT_ID
select error_number, error_name, SUM_ERROR_RAISED from performance_schema.events_errors_summary_global_by_error where error_number = 50118;
error_number	error_name	SUM_ERROR_RAISED
50118	ER_WRITE_QUERY_THROTTLED	4
####### Reset #######
use test;
TRUNCATE test.t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1;
SET @@SESSION.WRITE_THROTTLE_TAG_ONLY=FALSE;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=WARN;
drop database test1;
truncate table performance_schema.events_errors_summary_global_by_error;
set @@global.debug= '-d,dbug.simulate_lag_above_start_throttle_threshold';
select sleep(@wat_freq);
sleep(@wat_freq)
0
select sleep(@ws_freq - unix_timestamp()%@ws_freq);
sleep(@ws_freq - unix_timestamp()%@ws_freq)
0
####################################################
### Test End: Full Reset
####################################################
SET @@GLOBAL.WRITE_STATS_FREQUENCY=0;
DROP TABLE t;
SET @@GLOBAL.WRITE_STATS_COUNT=0;
SET @@GLOBAL.WRITE_AUTO_THROTTLE_FREQUENCY=0;
SET @@GLOBAL.WRITE_STATS_FREQUENCY=0;
SET @@GLOBAL.WRITE_THROTTLE_PATTERNS='OFF';
SET @@GLOBAL.WRITE_THROTTLE_LAG_PCT_MIN_SECONDARIES=100;
SET @@GLOBAL.WRITE_START_THROTTLE_LAG_MILLISECONDS=86400000;
SET @@GLOBAL.WRITE_STOP_THROTTLE_LAG_MILLISECONDS=86400000;
SET @@GLOBAL.WRITE_THROTTLE_MIN_RATIO=1000;
SET @@GLOBAL.WRITE_THROTTLE_MONITOR_CYCLES=1000;
SET @@GLOBAL.WRITE_CONTROL_LEVEL=OFF;
include/rpl_end.inc
