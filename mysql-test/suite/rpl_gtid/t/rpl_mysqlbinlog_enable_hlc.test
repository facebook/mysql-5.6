# The tests in this file is intended to test the following:
# 1. Binlog events containing Metadata event can be parsed by mysqlbinlog
# 2. Binlog events containing Metadata event can be applied to a mysql instance
# through mysqlbinlog
# 3. The HLC timestamp in Metadata event is retained when such events are
# applied through mysqlbinlog

--source include/have_debug.inc
--source include/master-slave.inc
--source include/have_binlog_format_row.inc

# Cleanup old binlog
connection master;
--source include/sync_slave_sql_with_master.inc
connection master;
flush logs;
let $binlog= query_get_value(SHOW MASTER STATUS, File, 1);
replace_result $binlog binlog;
eval purge binary logs to '$binlog';

connection slave;
flush logs;
let $binlog= query_get_value(SHOW MASTER STATUS, File, 1);
replace_result $binlog binlog;
eval purge binary logs to '$binlog';

# Setup
# Set minimum_hlc_ns to a high value. Subsequent txn's should see monotonically
# increasing timestamp from this point
connection master;
SET SESSION DEBUG="+d,allow_long_hlc_drift_for_tests";
SET @@global.minimum_hlc_ns = 2538630000000000000; # ~2050 AD

# Enable binlog_hlc in both master and slave
connection master;
SET @@global.enable_binlog_hlc = true;
connection slave;
SET @@global.enable_binlog_hlc = true;

# Stop the slave
--connection slave
--source include/stop_slave.inc

# Generate some trx in master
--echo Generate some txns in master instance
--connection master
create table t1 (a int primary key, b char(8)) engine=Innodb;

# Single-statement transaction
set @@session.autocommit= on;
insert into t1 values (1, 'a');

# Multi-statement transaction
set @@session.autocommit= off;
begin;
  insert into t1 values (2, 'b');
  insert into t1 values (3, 'c');
commit;

select * from t1;

--let $binlog_file= LAST
--source include/show_binlog_events.inc

# Try to restore t1 from binlog on the slave instance. The HLC values should
# be carried forward as seen in the master
--echo Restoring t1 on slave through mysqlbinlog should carry HLC from the master instance
--let $datadir= `SELECT @@datadir`
--let $binlog_file= query_get_value(SHOW MASTER STATUS, File, 1)

--exec $MYSQL_BINLOG $datadir/$binlog_file | $MYSQL --user=root --host=127.0.0.1 --port=$SLAVE_MYPORT
--let $diff_tables= master:t1, slave:t1
--source include/diff_tables.inc

--connection slave

select * from t1;

# Generate some txns explicitly on slave instance. HLC should increase
# monotonically
--echo HLC increases monotonically for txns generated on slave instance
create table t2 (a int primary key, b char(8)) engine=Innodb;
insert into t2 values (1, 'a');
insert into t2 values (2, 'b');

--let $binlog_file= LAST
--source include/show_binlog_events.inc

# Generate some more txns on master. HLC timestamp of master will be retained on
# slave when it applies using mysqlbinlog. HLC clock of slave will be
# updated accordingly. Also, flush logs so that a new binlog is generated with
# metadata event containing prev-hlc. This should be skipped/ignored by
# slave apply (when applied through mysqlbinlog)
--connection master
-- echo Generate some more txns on master instance
flush logs;

# Single-statement transaction
set @@session.autocommit= on;
insert into t1 values (4, 'd');
insert into t1 values (5, 'e');
insert into t1 values (6, 'f');

# Multi-statement transaction
set @@session.autocommit= off;
begin;
  insert into t1 values (7, 'g');
  insert into t1 values (8, 'h');
commit;

select * from t1;

--let $binlog_file= LAST
--source include/show_binlog_events.inc

# Try to restore t1 from binlog on the slave instance. The HLC values should
# be carried forward as seen in the master. HLC clock of slave should be updated
# so that any subsequent txns generated by slave should get a higher HLC
# timestamp
--echo Restoring t1 on slave through mysqlbinlog should carry HLC from the master instance
--let $datadir= `SELECT @@datadir`
--let $binlog_file= query_get_value(SHOW MASTER STATUS, File, 1)

--exec $MYSQL_BINLOG $datadir/$binlog_file | $MYSQL --user=root --host=127.0.0.1 --port=$SLAVE_MYPORT
--let $diff_tables= master:t1, slave:t1
--source include/diff_tables.inc

--connection slave

select * from t1;

# Generate some txns explicitly on slave instance. HLC should increase
# monotonically
--echo HLC increases monotonically for txns generated on slave instance
insert into t2 values (3, 'c');
insert into t2 values (4, 'd');
insert into t2 values (5, 'e');

--let $binlog_file= LAST
--source include/show_binlog_events.inc

# Generate some more txns on master and try to replay it on slave using
# skip-gtids. HLC timestamp of master will be retained on slave when it applies
# using mysqlbinlog event though it generates new gtid. HLC clock of slave 
# will be updated accordingly
--echo Generate some more txns on master and apply it on slave with --skip-gtids. HLC ts should be retained
--connection master
flush logs;

# Single-statement transaction
set @@session.autocommit= on;
insert into t1 values (9, 'i');
insert into t1 values (10, 'j');
insert into t1 values (11, 'k');
insert into t1 values (12, 'l');
insert into t1 values (13, 'm');

# Multi-statement transaction
set @@session.autocommit= off;
begin;
  insert into t1 values (14, 'n');
  insert into t1 values (15, 'o');
commit;

select * from t1;

--let $binlog_file= LAST
--source include/show_binlog_events.inc

--connection slave
flush logs;

--connection master
# Try to restore t1 from binlog on the slave instance using skip-gtids. 
# The HLC values should be carried forward as seen in the master. HLC clock of 
# slave should be updated so that any subsequent txns generated by slave 
# should get a higher HLC timestamp
--echo Restoring t1 on slave through mysqlbinlog should carry HLC from the master instance
--let $datadir= `SELECT @@datadir`
--let $binlog_file= query_get_value(SHOW MASTER STATUS, File, 1)

--exec $MYSQL_BINLOG --skip-gtids $datadir/$binlog_file | $MYSQL --user=root --host=127.0.0.1 --port=$SLAVE_MYPORT
--let $diff_tables= master:t1, slave:t1
--source include/diff_tables.inc

--connection slave

select * from t1;

# Generate some txns explicitly on slave instance. HLC should increase
# monotonically
--echo HLC increases monotonically for txns generated on slave instance
insert into t2 values (6, 'f');
insert into t2 values (7, 'g');

--let $binlog_file= LAST
--source include/show_binlog_events.inc
# cleanup
--connection master

flush logs;
drop table t1;
--let $binlog_file= query_get_value(SHOW MASTER STATUS, File, 1)
--exec $MYSQL_BINLOG $datadir/$binlog_file | $MYSQL --user=root --host=127.0.0.1 --port=$SLAVE_MYPORT
connection slave;
change replication source to source_auto_position=0;

# Cleanup
connection master;
SET @@global.minimum_hlc_ns = default;
SET @@global.enable_binlog_hlc = default;

connection slave;
drop table t2;
SET @@global.enable_binlog_hlc = default;
