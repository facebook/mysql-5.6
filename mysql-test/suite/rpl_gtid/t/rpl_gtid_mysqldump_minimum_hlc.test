# The tests in this file is intended to test the following:
# 1. mysqldump generates a sql to set minimum_hlc
# 2. When the sql generated by #1 is replayed on the destination instance, minimum_hlc is updated correctly
# 3. All subsequent trx in destination instance will get monotonically increasing HLC

--source include/have_debug.inc
--source include/have_binlog_format_row.inc
--source include/master-slave.inc

# Cleanup old binlog
--source include/rpl_connection_master.inc
FLUSH LOGS;
--let $binlog = query_get_value(SHOW MASTER STATUS, File, 1)
--replace_result $binlog binlog
--eval PURGE BINARY LOGS TO '$binlog'

--source include/sync_slave_sql_with_master.inc
--let $binlog = query_get_value(SHOW MASTER STATUS, File, 1)
--replace_result $binlog binlog
--eval PURGE BINARY LOGS TO '$binlog'

# Setup
# Set minimum_hlc_ns to a high value. Subsequent txn's should see monotonically
# increasing timestamp from this point
--source include/rpl_connection_master.inc
SET @@session.debug = "+d,allow_long_hlc_drift_for_tests";
--let $master_saved_minimum_hlc_ns = `SELECT @@global.minimum_hlc_ns`
SET @@global.minimum_hlc_ns = 2538630000000000000; # ~2050 AD

# Enable binlog_hlc in both master and slave
--let $master_saved_enable_binlog_hlc = `SELECT @@global.enable_binlog_hlc`
SET @@global.enable_binlog_hlc = TRUE;
--source include/rpl_connection_slave.inc
--let $slave_saved_minimum_hlc_ns = `SELECT @@global.minimum_hlc_ns`
--let $slave_saved_enable_binlog_hlc = `SELECT @@global.enable_binlog_hlc`
SET @@global.enable_binlog_hlc = TRUE;
--let $saved_maximum_hlc_drift_ns = `SELECT @@global.maximum_hlc_drift_ns`
SET @@global.maximum_hlc_drift_ns = 2538630000000000000; # ~2050 AD

# Stop the slave
--source include/rpl_connection_slave.inc
--source include/stop_slave.inc

# Generate some trx in master
--echo Generate some txns in master instance
--source include/rpl_connection_master.inc
CREATE TABLE t1 (a INT PRIMARY KEY, b CHAR(8)) ENGINE=InnoDB;
CREATE TABLE t2 (a INT PRIMARY KEY, b CHAR(8)) ENGINE=InnoDB;

# Single-statement transaction
SET @@session.autocommit = ON;
INSERT INTO t1 VALUES (1, 'a');
INSERT INTO t2 VALUES (1, 'a');

# Multi-statement transaction
SET @@session.autocommit = OFF;
BEGIN;
  INSERT INTO t1 VALUES (2, 'b');
  INSERT INTO t1 VALUES (3, 'c');
  INSERT INTO t2 VALUES (2, 'b');
  INSERT INTO t2 VALUES (3, 'c');
COMMIT;

SELECT * FROM t1;
SELECT * FROM t2;

--let $binlog_file = LAST
--source include/show_binlog_events.inc

# Try to restore t1 on slave instance by getting a dump in master
--echo Restoring t1 on slave through mysqlbinlog should carry HLC from the master instance
--exec $MYSQL_DUMP --user=root --host=127.0.0.1  --single-transaction --set-minimum-hlc --port=$MASTER_MYPORT test > $MYSQLTEST_VARDIR/tmp/mysqldump1.sql

--echo Now replay the dump on slave instance
--exec $MYSQL --user=root --host=127.0.0.1 --port=$SLAVE_MYPORT test < $MYSQLTEST_VARDIR/tmp/mysqldump1.sql

--let $diff_tables = master:t1, slave:t1
--source include/diff_tables.inc

--let $diff_tables = master:t2, slave:t2
--source include/diff_tables.inc

--source include/rpl_connection_slave.inc
SELECT * FROM t1;
SELECT * FROM t2;

# Generate some txns explicitly on slave instance. HLC should increase
# monotonically
--echo HLC increases monotonically for txns generated on slave instance
CREATE TABLE t3 (a INT PRIMARY KEY, b CHAR(8)) ENGINE=InnoDB;
INSERT INTO t3 VALUES (1, 'a');
INSERT INTO t3 VALUES (2, 'b');

--let $binlog_file = LAST
--source include/show_binlog_events.inc

DROP TABLE t3;
--source include/start_slave.inc

# Cleanup
--source include/rpl_connection_master.inc
--remove_file $MYSQLTEST_VARDIR/tmp/mysqldump1.sql
DROP TABLE t1;
DROP TABLE t2;
FLUSH LOGS;
SET @@session.debug = "-d,allow_long_hlc_drift_for_tests";
--eval SET @@global.minimum_hlc_ns = $master_saved_minimum_hlc_ns
--eval SET @@global.enable_binlog_hlc = $master_saved_enable_binlog_hlc
--source include/sync_slave_sql_with_master.inc
--source include/rpl_connection_slave.inc
--eval SET @@global.minimum_hlc_ns = $slave_saved_minimum_hlc_ns
--eval SET @@global.enable_binlog_hlc = $slave_saved_enable_binlog_hlc
--eval SET @@global.maximum_hlc_drift_ns = $saved_maximum_hlc_drift_ns

--source include/rpl_end.inc
