DROP TABLE if exists t1;
## Prepare test table
CREATE TABLE t1 (
id INT NOT NULL AUTO_INCREMENT,
fname CHAR(30) DEFAULT NULL,
lname CHAR(30) NOT NULL DEFAULT '',
PRIMARY KEY (id, lname),
INDEX ix_lname (lname)
) ENGINE=InnoDB
PARTITION BY RANGE (id)
SUBPARTITION BY KEY (lname)
SUBPARTITIONS 2
(PARTITION p0 VALUES LESS THAN (100) ENGINE = InnoDB,
PARTITION p1 VALUES LESS THAN (300) ENGINE = InnoDB,
PARTITION p2 VALUES LESS THAN (600) ENGINE = InnoDB,
PARTITION p3 VALUES LESS THAN MAXVALUE ENGINE = InnoDB);
INSERT INTO t1 VALUES (NULL, 'matt', 'lee'), (NULL, 'lara', 'kim'), (NULL, 'seonguck', 'ryu');
INSERT INTO t1 SELECT NULL, fname, lname FROM t1;
INSERT INTO t1 SELECT NULL, fname, lname FROM t1;
INSERT INTO t1 SELECT NULL, fname, lname FROM t1;
INSERT INTO t1 SELECT NULL, fname, lname FROM t1;
INSERT INTO t1 SELECT NULL, fname, lname FROM t1;
INSERT INTO t1 SELECT NULL, fname, lname FROM t1;
INSERT INTO t1 SELECT NULL, fname, lname FROM t1;
INSERT INTO t1 SELECT NULL, fname, lname FROM t1;
## Delete hole rows
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
DELETE FROM t1 WHERE id = ROUND(RAND()*1000) % 768;
## Test-1 defragment specific partition and index
ALTER TABLE t1 DEFRAGMENT PARTITION (p0sp0, P1SP1) INDEX PRIMARY;
## Test-2 defragment specific partition without index
ALTER TABLE t1 DEFRAGMENT PARTITION (p0sp0, P1SP1);
## Test-3 defragment specific index without partition
ALTER TABLE t1 DEFRAGMENT INDEX ix_lname;
## Test-4 defragment whole partitioned table
ALTER TABLE t1 DEFRAGMENT;
## Test-5 defragment specific partition and index (async commit)
ALTER TABLE t1 DEFRAGMENT PARTITION (p0sp0, P1SP1) INDEX PRIMARY async_commit;
## Test-6 defragment specific partition without index (async commit)
ALTER TABLE t1 DEFRAGMENT PARTITION (p0sp0, P1SP1) async_commit;
## Test-7 defragment specific index without partition (async commit)
ALTER TABLE t1 DEFRAGMENT INDEX ix_lname async_commit;
## Test-8 defragment whole partitioned table (async commit)
ALTER TABLE t1 DEFRAGMENT async_commit;
## Clean test table
DROP TABLE t1;
