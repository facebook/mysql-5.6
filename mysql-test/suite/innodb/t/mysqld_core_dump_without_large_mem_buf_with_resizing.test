################################################################################
# This test is to test if mysqld can dump a core without large memory buffers.
# See opt file for the config:
#   (1) core-file is set to enable core dump for mysqld
#   (2) the buffer pool is set to be large initially, shrink it, then expand
#       it back to the original large size, without dropping the large memory
#       buffers the core size will be greater than 5GB
#   (3) the default value of @@innodb_dump_core_without_large_mem_buf is true

--source include/not_valgrind.inc

--source include/have_innodb.inc

--source suite/innodb/t/innodb-buffer-pool-resize-setup.inc

# Shrink buffer pool to 20GB
set global innodb_buffer_pool_size = 21474836480;
--source include/wait_condition.inc

set global innodb_adaptive_hash_index=OFF;

# Expand buffer pool back to 60GB
set global innodb_buffer_pool_size = 64424509440;
--source include/wait_condition.inc

--disable_query_log
set global innodb_buffer_pool_size = @old_innodb_buffer_pool_size;
set global innodb_file_format = @old_innodb_file_format;
set global innodb_file_per_table = @old_innodb_file_per_table;
set global innodb_adaptive_hash_index = @old_innodb_adaptive_hash_index;
--enable_query_log
--source include/wait_condition.inc

--let $expected_max_core_size = 5120

--source include/mysqld_core_dump.inc
