# clean slate
reset master;

# setup
--let $master_uuid= `SELECT @@GLOBAL.SERVER_UUID`
create table t1(a int primary key, b char(8)) engine=innodb;
connect(con1,localhost,root,,);
connect(con2,localhost,root,,);

# conn1 is the session that becomes leader of the group. conn2 becomes the
# follower. conn1 simulates before commit error by setting
# simulate_before_commit_error. trxs in both sessions will be rolled back
# implicitly. binlog events generated by both trxs will be retained in the
# binlog.
--connection con1
set session debug="+d,simulate_before_commit_error";
set session debug="+d,become_group_leader";
--send insert into t1 values (1, 'a');

--connection con2
set session debug="+d,become_group_follower";
--send insert into t1 values (2, 'b');

--connection con1
--error ER_ERROR_DURING_COMMIT
--reap
--connection con2
--error ER_ERROR_DURING_COMMIT
--reap

# Cleanup
--disconnect con1
--disconnect con2

--connection default
# Verify that the trx was rolled back
select * from t1;

# Verify that gtid_executed table is maintained correctly
--replace_result $master_uuid MASTER_UUID
select * from mysql.gtid_executed;

# Inserting same keys into table should succeed since earlier trxs were rolled
# back releasing all row locks
insert into t1 values(1, 'a');
insert into t1 values(2, 'b');
select * from t1;

# Verify that gtid_executed table is maintained correctly without any holes
--replace_result $master_uuid MASTER_UUID
select * from mysql.gtid_executed;

# Binlog should retain events for the rolledback trxs
--source include/show_binlog_events.inc
drop table t1;
