create database test_db;
create user test_user@localhost;
grant all on test_db to test_user@localhost;
set @start_max_running_queries = @@global.max_running_queries;
set @@global.max_running_queries = 4;
set @start_innodb_lock_wait_timeout = @@global.innodb_lock_wait_timeout;
set @@global.innodb_lock_wait_timeout = 10000;
set @start_admission_control_filter = @@global.admission_control_filter;
set @@global.admission_control_filter = 'COMMIT';
create table t1 (a int) engine=innodb;
insert into t1 values(1);
begin;
update t1 set a=2 where a=1;
update t1 set a=2 where a=1;
update t1 set a=2 where a=1;
update t1 set a=2 where a=1;
update t1 set a=2 where a=1;
set @@global.admission_control_filter = 'ALTER,BEGIN,COMMIT,CREATE,DELETE,DROP,INSERT,LOAD,SELECT,SET,REPLACE,TRUNCATE,UPDATE';
create table t2(a int) engine=innodb;
begin;
insert into t2 values(1);
update t2 set a=2 where a=1;
commit;
alter table t2 rename t3;
select * from t3;
a
2
delete from t3;
set @val = 1;
truncate table t3;
drop table t3;
set @@global.admission_control_filter = 'ROLLBACK';
rollback;
set @@global.admission_control_filter = 'COMMIT';
commit;
set @@global.max_running_queries = @start_max_running_queries;
set @@global.innodb_lock_wait_timeout = @start_innodb_lock_wait_timeout;
set @@global.admission_control_filter = @start_admission_control_filter;
drop database test_db;
drop user test_user@localhost;
